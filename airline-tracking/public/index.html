<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Injection Demo - Part B</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-5">SQL Injection Demo - Part B</h1>
        <form id="vulnerableUpdateForm">
            <div class="form-group">
                <label for="flightCode">Flight Code</label>
                <input type="text" id="flightCode" class="form-control" placeholder="Enter Flight Code">
            </div>
            <div class="form-group">
                <label for="passengerLastName">Passenger Last Name</label>
                <input type="text" id="passengerLastName" class="form-control" placeholder="Enter Last Name">
            </div>
            <div class="form-group">
                <label for="newSeatingNumber">New Seating Number</label>
                <input type="text" id="newSeatingNumber" class="form-control" placeholder="Enter New Seating Number">
            </div>
            <button type="submit" class="btn btn-danger">Update</button>
        </form>
        <hr>
        <h2 class="mt-5">Search Results</h2>
        <table class="table table-bordered" id="resultsTable">
            <thead>
                <tr>
                    <th>Flight Code</th>
                    <th>Seating Number</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Group Number</th>
                </tr>
            </thead>
            <tbody>
                <!-- Results will be populated here -->
            </tbody>
        </table>
    </div>

    <script>
        document.getElementById('vulnerableUpdateForm').addEventListener('submit', async function (event) {
            event.preventDefault();

            const flightCode = document.getElementById('flightCode').value;
            const passengerLastName = document.getElementById('passengerLastName').value;
            const newSeatingNumber = document.getElementById('newSeatingNumber').value;

            try {
                const updateResponse = await fetch('/update-tickets-vulnerable', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ flightCode, passengerLastName, newSeatingNumber }),
                });

                const updateResult = await updateResponse.json();

                if (updateResult.success) {
                    alert(`Successfully updated ticket for ${passengerLastName} on flight ${flightCode}.`);
                    refreshSearchResults();
                } else {
                    alert(`Error: ${updateResult.message}`);
                }
            } catch (error) {
                console.error('Error performing update:', error);
                alert('An error occurred while attempting the update.');
            }
        });

        async function refreshSearchResults() {
            try {
                const response = await fetch('/tickets');
                const results = await response.json();

                const resultsTable = document.getElementById('resultsTable').querySelector('tbody');
                resultsTable.innerHTML = '';

                results.forEach(ticket => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${ticket.FlightCode}</td>
                        <td>${ticket.SeatingNumber}</td>
                        <td>${ticket.PassengerFirstName}</td>
                        <td>${ticket.PassengerLastName}</td>
                        <td>${ticket.GroupNumber}</td>
                    `;
                    resultsTable.appendChild(row);
                });
            } catch (error) {
                console.error('Error refreshing results table:', error);
            }
        }
        document.addEventListener('DOMContentLoaded', refreshSearchResults);
    </script>
</body>
</html>
